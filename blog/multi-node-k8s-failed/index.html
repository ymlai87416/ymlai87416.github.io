<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>3 nodes Kubernetes cluster failed due to cert error - Tom personal site</title><meta name=Description content="Tom personal web site"><meta property="og:title" content="3 nodes Kubernetes cluster failed due to cert error"><meta property="og:description" content="1 year before I setup a Kubernetes cluster with 3 master nodes and 1 worker node, and today I got the following error
I don&rsquo;t know that all the certs generated only have 1 year lifespan. Document says during update of cluster version should automatically update all the certs, but I don&rsquo;t have the time&mldr;
1 2  kubectl get pods --all-namespaces kubectl: Unable to connect to the server: x509: certificate has expired or is not yet valid   Update process I found the following article."><meta property="og:type" content="article"><meta property="og:url" content="https://ymlai87416.github.io/blog/multi-node-k8s-failed/"><meta property="og:image" content="https://ymlai87416.github.io/logo.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-04-09T00:00:00+08:00"><meta property="article:modified_time" content="2022-04-09T00:00:00+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ymlai87416.github.io/logo.png"><meta name=twitter:title content="3 nodes Kubernetes cluster failed due to cert error"><meta name=twitter:description content="1 year before I setup a Kubernetes cluster with 3 master nodes and 1 worker node, and today I got the following error
I don&rsquo;t know that all the certs generated only have 1 year lifespan. Document says during update of cluster version should automatically update all the certs, but I don&rsquo;t have the time&mldr;
1 2  kubectl get pods --all-namespaces kubectl: Unable to connect to the server: x509: certificate has expired or is not yet valid   Update process I found the following article."><meta name=application-name content="Tom personal web site"><meta name=apple-mobile-web-app-title content="Tom personal web site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ymlai87416.github.io/blog/multi-node-k8s-failed/><link rel=prev href=https://ymlai87416.github.io/blog/change-in-infra/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"3 nodes Kubernetes cluster failed due to cert error","inLanguage":"zh","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ymlai87416.github.io\/blog\/multi-node-k8s-failed\/"},"image":["https:\/\/ymlai87416.github.io\/images\/Apple-Devices-Preview.png"],"genre":"blog","keywords":"computer science, infrastructure","wordcount":476,"url":"https:\/\/ymlai87416.github.io\/blog\/multi-node-k8s-failed\/","datePublished":"2022-04-09T00:00:00+08:00","dateModified":"2022-04-09T00:00:00+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Tom","logo":"https:\/\/ymlai87416.github.io\/images\/avatar.jpg"},"author":{"@type":"Person","name":"Lai Yiu Ming, Tom"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Tom personal site">Tom personal site</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/about/>About </a><a class=menu-item href=/blog/>Blog </a><a class=menu-item href=/cheatsheet/>Cheatsheet </a><a class=menu-item href=/tools/>Tools </a><a class=menu-item href=/link/>Link </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title>
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Tom personal site">Tom personal site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/about/ title>About</a><a class=menu-item href=/blog/ title>Blog</a><a class=menu-item href=/cheatsheet/ title>Cheatsheet</a><a class=menu-item href=/tools/ title>Tools</a><a class=menu-item href=/link/ title>Link</a><a href=javascript:void(0); class="menu-item theme-switch" title>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title></h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">3 nodes Kubernetes cluster failed due to cert error</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Lai Yiu Ming, Tom</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-04-09>2022-04-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span></span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#update-process>Update process</a></li><li><a href=#after-update>After update</a></li><li><a href=#re-add-master-node>Re-add master node</a><ul><li><a href=#on-k8s-master01>On k8s-master01</a></li><li><a href=#on-k8s-master02>On k8s-master02</a></li><li><a href=#clear-etc>Clear etc</a></li><li><a href=#finally>Finally</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>1 year before I setup a Kubernetes cluster with 3 master nodes and 1 worker node, and today I got the following error</p><p>I don&rsquo;t know that all the certs generated only have 1 year lifespan. Document says during update of cluster version should automatically update all the certs, but I don&rsquo;t have the time&mldr;</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl get pods --all-namespaces
</span></span><span class=line><span class=cl>kubectl: Unable to connect to the server: x509: certificate has expired or is not yet valid
</span></span></code></pre></td></tr></table></div></div><h2 id=update-process>Update process</h2><p>I found the following article. Solve the certificate error, but&mldr;</p><p>Please follow this <a href=https://github.com/toracigno/kb/wiki/K8s-API-server-certificate-renewal target=_blank rel="noopener noreffer">link</a> to complete the setup.</p><h2 id=after-update>After update</h2><p>I do a health check and I saw this</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ubuntu@k8s-master02:/etc/kubernetes$ kubectl get nodes
</span></span><span class=line><span class=cl>NAME           STATUS   ROLES                  AGE    VERSION
</span></span><span class=line><span class=cl>k8s-master01   Ready    control-plane,master   367d   v1.20.5
</span></span><span class=line><span class=cl>k8s-master02   NotReady    control-plane,master   367d   v1.20.5
</span></span><span class=line><span class=cl>k8s-master03   Ready    control-plane,master   367d   v1.20.5
</span></span><span class=line><span class=cl>k8s-node01     Ready    &lt;none&gt;                 367d   v1.20.5
</span></span></code></pre></td></tr></table></div></div><p>I login to k8s-master02.</p><p>run <code>journalctl -u kubelet</code> shows the following error</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Attempting to register node k8s-master02
</span></span><span class=line><span class=cl>Apr 09 05:25:17 k8s-master02 kubelet[744]: E0409 05:25:17.570172     744 kubelet_node_status.go:93] Unable to register node  with API server: nodes is forbidden: User &#34;system:anonymous&#34; cannot create resource &#34;nodes&#34; in API group &#34;&#34; at the cluster scope
</span></span></code></pre></td></tr></table></div></div><h2 id=re-add-master-node>Re-add master node</h2><p>I search Google, seems no one have the same error, so I have to delete the k8s-master02 node and re-add.</p><h3 id=on-k8s-master01>On k8s-master01</h3><p>Before removing k8s-master02, I need to find a way to add k8s-master02 back</p><p>This stackoverflow page is helpful
<a href=https://stackoverflow.com/questions/63936268/how-to-generate-kubeadm-token-for-secondary-control-plane-nodes target=_blank rel="noopener noreffer">https://stackoverflow.com/questions/63936268/how-to-generate-kubeadm-token-for-secondary-control-plane-nodes</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># temporary add a upload certs for joining new control plane. (Valid only for 2 hours)</span>
</span></span><span class=line><span class=cl>kubeadm init phase upload-certs --upload-certs
</span></span><span class=line><span class=cl><span class=c1># ask k8s to generate the join command</span>
</span></span><span class=line><span class=cl>kubeadm token create --print-join-command
</span></span></code></pre></td></tr></table></div></div><p>remove k8s-master02</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl drain k8s-master02
</span></span><span class=line><span class=cl>kubectl delete node k8s-master02
</span></span></code></pre></td></tr></table></div></div><h3 id=on-k8s-master02>On k8s-master02</h3><p>Now, I have the join command, I run the following commands</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubeadm reset
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubeadm join 192.168.100.20:6444 --token pel8cz.mtvnu0n7q8aj6lx6     --discovery-token-ca-cert-hash sha256:xxxxxxx --control-plane --certificate-key xxxxxxxx
</span></span></code></pre></td></tr></table></div></div><p>another error come out&mldr;.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1006 18:54:08.820819    2954 manifests.go:135] [control-plane] wrote static Pod manifest for component &#34;kube-scheduler&#34; to &#34;/etc/kubernetes/manifests/kube-scheduler.yaml&#34;
</span></span><span class=line><span class=cl>[check-etcd] Checking that the etcd cluster is healthy
</span></span><span class=line><span class=cl>failed to dial endpoint https://192.168.100.22:2379 with maintenance client
</span></span></code></pre></td></tr></table></div></div><h3 id=clear-etc>Clear etc</h3><p>This page helps me to troubleshoot. <a href=https://stackoverflow.com/questions/67921552/re-installed-node-cannot-join-kubernetes-cluster target=_blank rel="noopener noreffer">https://stackoverflow.com/questions/67921552/re-installed-node-cannot-join-kubernetes-cluster</a></p><p>Back to k8s-master01</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># have to install etc-client on ubuntu</span>
</span></span><span class=line><span class=cl><span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span> etcdctl --endpoints 127.0.0.1:2379 --cacert /etc/kubernetes/pki/etcd/ca.crt --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key member list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># list of etcd member</span>
</span></span><span class=line><span class=cl>5a4945140f0b39d9, started, sbg2-k8s001, https://192.168.208.12:2380, https://192.168.208.12:2379
</span></span><span class=line><span class=cl>740381e3c57ef823, started, gra3-k8s001, https://192.168.208.13:2380, https://192.168.208.13:2379
</span></span><span class=line><span class=cl>77a8fbb530b10f4a, started, rbx4-k8s001, https://192.168.208.14:2380, https://192.168.208.14:2379
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># remove k8s-master02 from the above list</span>
</span></span><span class=line><span class=cl><span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span> etcdctl --endpoints 127.0.0.1:2379 --cacert /etc/kubernetes/pki/etcd/ca.crt --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key member remove e073aa5a204b727d
</span></span></code></pre></td></tr></table></div></div><h3 id=finally>Finally</h3><p>I am able to re-join k8s-master02 now and all nodes are healthy.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>NAME           STATUS   ROLES                  AGE    VERSION
</span></span><span class=line><span class=cl>k8s-master01   Ready    control-plane,master   367d   v1.20.5
</span></span><span class=line><span class=cl>k8s-master02   Ready    control-plane,master   31s    v1.20.5
</span></span><span class=line><span class=cl>k8s-master03   Ready    control-plane,master   367d   v1.20.5
</span></span><span class=line><span class=cl>k8s-node01     Ready    &lt;none&gt;                 367d   v1.20.5
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/blog/multi-node-k8s-failed/index.md target=_blank></a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/computer-science/>computer science</a>,&nbsp;<a href=/tags/infrastructure/>infrastructure</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()></a></span>&nbsp;|&nbsp;<span><a href=/></a></span></section></div><div class=post-nav><a href=/blog/change-in-infra/ class=prev rel=prev title="Change in my personal infrastructure"><i class="fas fa-angle-left fa-fw"></i>Change in my personal infrastructure</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2016 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Lai Yiu Ming, Tom</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"",maxShownLines:100},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>