<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Upgrade Kubernetes from 1.20 to 1.21 - Tom personal site</title><meta name=Description content="Tom personal web site"><meta property="og:title" content="Upgrade Kubernetes from 1.20 to 1.21"><meta property="og:description" content="I am writing to document the upgrade process from Kubernetes 1.21 to 1.22.
Kubernetes end of life schedule
The process is same as my previous post. link.
But this time, it break many things.
Current setup I have installed some services on the cluster, and I don&rsquo;t have helm installed.
Because sometimes I need to edit the yaml before applying it.
Currently, I have the following software installed:
 ingress-nginx: v0."><meta property="og:type" content="article"><meta property="og:url" content="https://ymlai87416.github.io/blog/upgrade-k8s-v121-v122/"><meta property="og:image" content="https://ymlai87416.github.io/logo.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-04-11T15:04:19+01:00"><meta property="article:modified_time" content="2022-04-11T15:04:19+01:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ymlai87416.github.io/logo.png"><meta name=twitter:title content="Upgrade Kubernetes from 1.20 to 1.21"><meta name=twitter:description content="I am writing to document the upgrade process from Kubernetes 1.21 to 1.22.
Kubernetes end of life schedule
The process is same as my previous post. link.
But this time, it break many things.
Current setup I have installed some services on the cluster, and I don&rsquo;t have helm installed.
Because sometimes I need to edit the yaml before applying it.
Currently, I have the following software installed:
 ingress-nginx: v0."><meta name=application-name content="Tom personal web site"><meta name=apple-mobile-web-app-title content="Tom personal web site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ymlai87416.github.io/blog/upgrade-k8s-v121-v122/><link rel=prev href=https://ymlai87416.github.io/blog/k8s-move-to-containerd/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Upgrade Kubernetes from 1.20 to 1.21","inLanguage":"zh","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ymlai87416.github.io\/blog\/upgrade-k8s-v121-v122\/"},"image":["https:\/\/ymlai87416.github.io\/images\/Apple-Devices-Preview.png"],"genre":"blog","keywords":"computer science, infrastructure","wordcount":314,"url":"https:\/\/ymlai87416.github.io\/blog\/upgrade-k8s-v121-v122\/","datePublished":"2022-04-11T15:04:19+01:00","dateModified":"2022-04-11T15:04:19+01:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Tom","logo":"https:\/\/ymlai87416.github.io\/images\/avatar.jpg"},"author":{"@type":"Person","name":"Lai Yiu Ming, Tom"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Tom personal site">Tom personal site</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/about/>About </a><a class=menu-item href=/blog/>Blog </a><a class=menu-item href=/cheatsheet/>Cheatsheet </a><a class=menu-item href=/tools/>Tools </a><a class=menu-item href=/link/>Link </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title>
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Tom personal site">Tom personal site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/about/ title>About</a><a class=menu-item href=/blog/ title>Blog</a><a class=menu-item href=/cheatsheet/ title>Cheatsheet</a><a class=menu-item href=/tools/ title>Tools</a><a class=menu-item href=/link/ title>Link</a><a href=javascript:void(0); class="menu-item theme-switch" title>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title></h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Upgrade Kubernetes from 1.20 to 1.21</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Lai Yiu Ming, Tom</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-04-11>2022-04-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span></span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#current-setup>Current setup</a></li><li><a href=#upgrading-ingress-nginx>Upgrading ingress-nginx</a></li><li><a href=#upgrading-cert-manager>Upgrading cert-manager</a></li><li><a href=#final-words>Final words</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></div><div class=content id=content><p>I am writing to document the upgrade process from Kubernetes 1.21 to 1.22.</p><p><a href=https://endoflife.date/kubernetes target=_blank rel="noopener noreffer">Kubernetes end of life schedule</a></p><p>The process is same as my previous post. <a href=https://ymlai87416.github.io/blog/upgrade-k8s-v120/ rel>link</a>.</p><p>But this time, it break many things.</p><h2 id=current-setup>Current setup</h2><p>I have installed some services on the cluster, and I don&rsquo;t have helm installed.</p><p>Because sometimes I need to edit the yaml before applying it.</p><p>Currently, I have the following software installed:</p><ul><li>ingress-nginx: v0.46</li><li>cert-manager: v1.2</li></ul><p>After upgrading the cluster to v1.22, some pods are not running and become <code>CrashLoopBackOff</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ubuntu@k8s-master01:~/install/tatson-k8s$ kubectl get pods --namespace=ingress-nginx
</span></span><span class=line><span class=cl>NAME                                        READY   STATUS             RESTARTS       AGE
</span></span><span class=line><span class=cl>ingress-nginx-controller-6d5cfc9f7d-7jkrq   0/1     CrashLoopBackOff   11 (80s ago)   32m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ubuntu@k8s-master01:~/install/tatson-k8s$ kubectl get pods --namespace=cert-manager
</span></span><span class=line><span class=cl>NAME                                       READY   STATUS    RESTARTS         AGE
</span></span><span class=line><span class=cl>cert-manager-6588898cb4-w7hg8              1/1     Running   0                60m
</span></span><span class=line><span class=cl>cert-manager-cainjector-7bcbdbd99f-zflt5   0/1     Error     15 (5m41s ago)   60m
</span></span><span class=line><span class=cl>cert-manager-webhook-5fd9f9dd86-c4vv8      1/1     Running   0                60m
</span></span></code></pre></td></tr></table></div></div><h2 id=upgrading-ingress-nginx>Upgrading ingress-nginx</h2><p>Should be fine by just applying the latest version of yaml file.</p><p>For bare metal:</p><p>kubectl apply -f <a href=https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.3/deploy/static/provider/baremetal/deploy.yaml target=_blank rel="noopener noreffer">https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.3/deploy/static/provider/baremetal/deploy.yaml</a></p><p>But applying these result in</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Resource: &#34;batch/v1, Resource=jobs&#34;, GroupVersionKind: &#34;batch/v1, Kind=Job&#34;
</span></span><span class=line><span class=cl>Name: &#34;ingress-nginx-admission-create&#34;, Namespace: &#34;ingress-nginx&#34;
</span></span><span class=line><span class=cl>for: &#34;https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.2/deploy/static/provider/cloud/deploy.yaml&#34;: Job.batch &#34;ingress-nginx-admission-create&#34; is invalid: spec.template: Invalid value: core.PodTemplateSpec{ObjectMeta:v1.ObjectMeta{Name:&#34;ingress-nginx-admission-create&#34;, 
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Resource: &#34;batch/v1, Resource=jobs&#34;, GroupVersionKind: &#34;batch/v1, Kind=Job&#34;
</span></span><span class=line><span class=cl>Name: &#34;ingress-nginx-admission-patch&#34;, Namespace: &#34;ingress-nginx&#34;
</span></span><span class=line><span class=cl>for: &#34;https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.2/deploy/static/provider/cloud/deploy.yaml&#34;: Job.batch &#34;ingress-nginx-admission-patch&#34; is invalid: spec.template: Invalid value: 
</span></span></code></pre></td></tr></table></div></div><p>To resolve these, just delete the job under ingress-nginx.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>NAME                             COMPLETIONS   DURATION   AGE
</span></span><span class=line><span class=cl>ingress-nginx-admission-create   1/1           1s         3h37m
</span></span><span class=line><span class=cl>ingress-nginx-admission-patch    1/1           1s         3h37m
</span></span></code></pre></td></tr></table></div></div><h2 id=upgrading-cert-manager>Upgrading cert-manager</h2><p>From the website, it advise to upgrade to the next minor version, so I have to upgrade from v1.2 to v1.3, and then v1.4, v1.5, v1.6 and finally v1.7</p><p>The upgrade returns no error, and seems everything is running fine.</p><h2 id=final-words>Final words</h2><p>I totally not aware of these software need to be updated also. I should have reviewed my Kubernetes cluster at least semi-yearly.</p><h2 id=reference>Reference</h2><p>[1] Ingress-nginx support version: <a href=https://github.com/kubernetes/ingress-nginx#support-versions-table target=_blank rel="noopener noreffer">https://github.com/kubernetes/ingress-nginx#support-versions-table</a></p><p>[2] Cert manager supported release: <a href=https://cert-manager.io/docs/installation/supported-releases/ target=_blank rel="noopener noreffer">https://cert-manager.io/docs/installation/supported-releases/</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/blog/upgrade-k8s-v121-v122/index.md target=_blank></a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/computer-science/>computer science</a>,&nbsp;<a href=/tags/infrastructure/>infrastructure</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()></a></span>&nbsp;|&nbsp;<span><a href=/></a></span></section></div><div class=post-nav><a href=/blog/k8s-move-to-containerd/ class=prev rel=prev title="Kubernetes move from docker to containerd"><i class="fas fa-angle-left fa-fw"></i>Kubernetes move from docker to containerd</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2016 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Lai Yiu Ming, Tom</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"",maxShownLines:100},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>